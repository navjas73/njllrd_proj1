#!/usr/bin/env python
import rospy
from njllrd_proj1.srv import *
from njllrd_proj1.msg import *
import time
from std_msgs.msg import String

# When topic "command" is published to, reads block orientation mode and
#   starts relevant process
def mode_selection(data):
    if data.data == "scatter":
        scatter()
    elif data.data == "stack_ascending":
        stack_ascending()
    elif data.data == "stack_descending":
        stack_descending()
    elif data.data == "odd_even":
        odd_even()
    else: 
        print("Invalid mode")


# Initiates request to move_robot service (handled by robot interface server)
def request_movement(action, target):
    try:
        request = rospy.ServiceProxy('move_robot', move_robot)
        output = request(action,target)
        if output == False:
            print "Invalid movement"
        else:
            print "Successfully moved"
    except rospy.ServiceException, e:
        print "Service call failed: %s" %e
    
def scatter():
    # Code for moving blocks with scattered orientation
    return

def stack_ascending():
    # Code for moving blocks with stacked ascending orientation
    num_blocks = rospy.get_param("/num_blocks")
    rate = rospy.Rate(.2)
    for i in range(0,num_blocks):
        request_movement("close_gripper", 1)
        rate.sleep()
        request_movement("move_over_block", 0+i) # virtual block (table)
        rate.sleep()
        request_movement("open_gripper", 1)
        rate.sleep()
        if i != (num_blocks-1):
            request_movement("move_to_block",num_blocks-i-1)
            rate.sleep()
        

def stack_descending():
    # Code for moving blocks with stacked descending orientation
    return

def odd_even():
    return

def read_state():
    return

def controller():
    rospy.init_node('controller')
    rospy.wait_for_service('move_robot')
    rospy.Subscriber('command', String, mode_selection)
    # rospy.Subscriber('state', state, read_state)
    
    # time.sleep(10)
    rospy.spin()

if __name__ == "__main__":
    controller()
    


